---
title: "Visualizing geospatial data I"
author: "MACS 40700 <br /> University of Chicago"
output: rcfss::xaringan_wide
---

```{r setup, include = FALSE, cache = FALSE}
# generate CSS file
library(xaringanthemer)
rcfss::xaringan_theme()

# source in the default knitr options
source(here::here("R", "slide-opts.R"))
knitr::opts_chunk$set(echo = FALSE)

# enable panelsets and default theme
xaringanExtra::use_panelset()
# ggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))

# load basic packages
library(knitr)
library(here)
library(countdown)
library(patchwork)
```

class: inverse, middle

# Setup

---

## Setup

```{r pkgs, message = FALSE, cache = FALSE, echo = TRUE}
# load packages
library(tidyverse)
library(sf)
library(ggmap)
library(patchwork)
library(rnaturalearth)

# set default theme for ggplot2
ggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))

# set default figure parameters for knitr
knitr::opts_chunk$set(
  fig.width = 8, fig.asp = 0.618,
  fig.retina = 2, dpi = 150
)
```

---

## Geospatial visualizations

* Earliest form of information visualizations
* Geospatial data visualizations
* [Google Maps](https://www.google.com/maps)

---

## Not that Jon Snow

```{r echo = FALSE}
include_graphics(path = "https://media.giphy.com/media/3ohzdUi5U8LBb4GD4s/giphy.gif")
```

---

## Dr. John Snow

```{r echo = FALSE, out.width = "50%"}
include_graphics(path = "https://upload.wikimedia.org/wikipedia/commons/thumb/2/27/Snow-cholera-map-1.jpg/2183px-Snow-cholera-map-1.jpg")
```

.footnote[Source: [Wikipedia](https://en.wikipedia.org/wiki/John_Snow)]

---

## Designing modern maps

* Depict spatial features
* Incorporate additional attributes and information
* Major features
    * Scale
    * Projection
    * Symbols

---

## Scale

* Proportion between distances and sizes on a map and their actual distances and sizes on Earth
* Small-scale map
* Large-scale map

---

## Large-scale map

```{r large-scale}
# establish bounding box, get map, and plot
c(
  left = -128.364258,
  bottom = 11.480025,
  right = -65.742188,
  top = 55.329144
) %>%
  get_stamenmap(zoom = 5) %>%
  ggmap()
```

---

## Small-scale map

```{r small-scale}
# establish bounding box, get map, and plot
c(
  left = -87.612448,
  bottom = 41.783393,
  right = -87.581871,
  top = 41.803470
) %>%
  get_stamenmap(zoom = 15) %>%
  ggmap()
```

---

## Projection

* Process of taking a three-dimensional object and visualizing it on a two-dimensional surface
* No 100% perfect method for this
* Always introduces distortions
* Properties of projection methods
    1. Shape
    1. Area
    1. Angles
    1. Distance
    1. Direction

---

## Conformal projections

```{r import-world, include = FALSE}
world <- ne_countries(returnclass = "sf")
```

```{r mercator, dependson = "import-world"}
world %>%
  st_transform("+proj=merc") %>%
  ggplot() +
  geom_sf() +
  ggtitle("Mercator projection")
```

---

## Equal-area projections

```{r equal-area, dependson = "import-world"}
{
  world %>%
    st_transform("+proj=laea") %>%
    ggplot() +
    geom_sf() +
    ggtitle("Lambert equal area") +
    theme_minimal(base_size = rcfss::base_size * .7)
} +
  {
    world %>%
      st_transform("+proj=cea") %>%
      ggplot() +
      geom_sf() +
      ggtitle("Equal area cylindrical") +
      theme_minimal(base_size = rcfss::base_size * .7)
  } +
  plot_layout(ncol = 1, heights = c(5, 5))
```

---

## Mollweide

```{r mollweide, dependson = "import-world"}
world %>%
  st_transform("+proj=moll") %>%
  ggplot() +
  geom_sf() +
  ggtitle("Mollweide projection")
```

---

## Symbols

```{r bb-hydepark-stamen}
# store bounding box coordinates
hydepark_bb <- c(
  left = -87.612448,
  bottom = 41.783393,
  right = -87.581871,
  top = 41.803470
)

hydepark_stamen <- get_stamenmap(
  bbox = hydepark_bb,
  zoom = 16
)
ggmap(hydepark_stamen)
```

---

class: inverse, middle

# `ggmap` for raster maps

---

## `ggmap`

- Package for drawing maps using `ggplot2` and **raster** map tiles
- Static image files generated by mapping services
- Focus on incorporating data into existing maps
- Severely limits ability to change the appearance of the geographic map
- Specifying map region

---

## Bounding box

.panelset[
```{r panelset = c(output = "Plot", source = "Code"), echo = TRUE, out.width = "70%"}
chi_bb <- c(
  left = -87.936287,
  bottom = 41.679835,
  right = -87.447052,
  top = 42.000835
)
chicago <- get_stamenmap(
  bbox = chi_bb,
  zoom = 11
)
ggmap(chicago)
```
]

---

## Level of detail

```{r bb-chicago-stamen-zoom}
{
  get_stamenmap(
    bbox = chi_bb,
    zoom = 12
  ) %>%
    ggmap() +
    ggtitle("Zoom = 12")
} + {
  get_stamenmap(
    bbox = chi_bb,
    zoom = 10
  ) %>%
    ggmap() +
    ggtitle("Zoom = 10")
}
```

---

## Identifying bounding box

> Use [bboxfinder.com](http://bboxfinder.com/#0.000000,0.000000,0.000000,0.000000) to determine the exact longitude/latitude coordinates for the bounding box you wish to obtain.

---

## Types of map tiles

```{r stamen-maptype, echo = FALSE}
stamen_maptype <- tibble(maptype = c(
  "terrain", "terrain-background",
  "terrain-lines",
  "toner", "toner-2010", "toner-2011",
  "toner-background", "toner-hybrid",
  "toner-labels", "toner-lines",
  "toner-lite", "watercolor"
)) %>%
  mutate(
    bb = map(maptype, ~ get_stamenmap(bbox = chi_bb, zoom = 10, maptype = .x)),
    ggmap = map2(bb, maptype, ~ ggmap(.x) +
      ggtitle(.y) +
      theme_minimal(base_size = rcfss::base_size * 0.4))
  )

wrap_plots(stamen_maptype$ggmap)
```

---

## Import crime data

* City of Chicago open data portal
* [Crime data from 2017](https://data.cityofchicago.org/Public-Safety/Crimes-2017/d62x-nvdr)

```{r import-crimes, echo = TRUE}
crimes <- read_csv("data/chicago-crimes.csv")
glimpse(crimes)
```

---

## Plot high-level map of crime

.panelset[
```{r import-chicago, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), echo = TRUE, out.width = "70%"}
ggmap(chicago)
```
]

---

## Using `geom_point()`

.panelset[
```{r plot-crime-point, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), echo = TRUE, out.width = "70%"}
ggmap(chicago) +
  geom_point(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude
    )
  )
```
]

---

## Using `geom_point()`

.panelset[
```{r plot-crime-point-alpha, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), echo = TRUE, out.width = "70%"}
ggmap(chicago) +
  geom_point(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude
    ),
    size = .25,
    alpha = .01
  )
```
]

---

## Using `stat_density_2d()`

.panelset[
```{r kde-contour, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), echo = TRUE, out.width = "70%"}
ggmap(chicago) +
  geom_density_2d(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude
    )
  )
```
]

---

## Using `stat_density_2d()`

.panelset[
```{r kde-fill, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), echo = TRUE, out.width = "70%"}
ggmap(chicago) +
  stat_density_2d(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    geom = "polygon"
  )
```
]

---

## Using `stat_density_2d()`

.panelset[
```{r plot-crime-density, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), echo = TRUE, out.width = "70%"}
ggmap(chicago) +
  stat_density_2d(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    alpha = .2,
    bins = 25,
    geom = "polygon"
  )
```
]

---

## Looking for variation

.panelset[
```{r plot-crime-wday, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), echo = TRUE, out.width = "70%"}
ggmap(chicago) +
  stat_density_2d(
    data = crimes %>%
      filter(`Primary Type` %in% c(
        "BURGLARY", "MOTOR VEHICLE THEFT",
        "NARCOTICS", "ROBBERY"
      )),
    mapping = aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    alpha = .4,
    bins = 10,
    geom = "polygon"
  ) +
  facet_wrap(facets = vars(`Primary Type`))
```
]

---

## Exercise using `ggmap`

- City of Chicago data portal
- 311 service requests

```{r cache = FALSE}
countdown(minutes = 15)
```
