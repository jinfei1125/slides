---
title: "Optimizing color spaces"
author: "MACS 40700 <br /> University of Chicago"
output: rcfss::xaringan_wide
---

```{r setup, include = FALSE, cache = FALSE}
# generate CSS file
library(xaringanthemer)
rcfss::xaringan_theme()

# source in the default knitr options
source(here::here("R", "slide-opts.R"))
knitr::opts_chunk$set(
  echo = FALSE
)

# enable panelsets and default theme
xaringanExtra::use_panelset()
ggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))

# load basic packages
library(knitr)
library(here)
library(countdown)
library(patchwork)
```

```{r pkgs, include = FALSE, cache = FALSE}
library(tidyverse)
library(readxl)
library(urbnmapr)
library(here)
library(patchwork)
library(knitr)
library(palmerpenguins)
library(colorblindr)
library(rnaturalearth)
library(tidycensus)
library(scales)
library(RColorBrewer)
library(ggrepel)
library(cowplot)

# useful on MacOS to speed up rendering of geom_sf() objects
if (!identical(getOption("bitmapType"), "cairo") && isTRUE(capabilities()[["cairo"]])) {
  options(bitmapType = "cairo")
}

theme_set(theme_minimal())

# map theme
theme_map <- function(base_size, ...) {
  theme_minimal(base_size = base_size) +
    theme(
      text = element_text(family = "Ubuntu Regular", color = "#22211d"),
      axis.line = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
      panel.grid.minor = element_blank(),
      plot.background = element_rect(fill = "#f5f5f2", color = NA),
      panel.background = element_rect(fill = "#f5f5f2", color = NA),
      legend.background = element_rect(fill = "#f5f5f2", color = NA),
      panel.border = element_blank(),
      ...
    )
}

set.seed(123)
theme_set(theme_minimal(base_size = rcfss::base_size - 2))
```

# Uses of color in data visualization

--

<table style = "border: none; line-height: 2.5;">
<tr style = "background: white;">
<td style = "text-align: left; width: 50%;">
1. Distinguish categories (qualitative)
</td>
<td>
<img src = "images/qualitative.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>
</table>

---

# Qualitative scale example

```{r popgrowth-vs-popsize-colored, out.width = "70%"}
US_census <- read_csv("data/US_census.csv")
US_regions <- read_csv("data/US_regions.csv")

popgrowth <- left_join(US_census, US_regions) %>%
    group_by(region, division, state) %>%
    summarize(
      pop2000 = sum(pop2000, na.rm = TRUE),
      pop2010 = sum(pop2010, na.rm = TRUE),
      popgrowth = (pop2010-pop2000)/pop2000
    ) %>%
    arrange(popgrowth) %>%
    ungroup() %>%
    mutate(
      #state = factor(state, levels = state),
      region = factor(region, levels = c("West", "South", "Midwest", "Northeast"))
    )

region_colors <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442")

labeled_states <- c(
  "Alaska", "Arizona", "California", "Florida", "Wisconsin", 
  "Louisiana", "Nevada", "Michigan", "Montana", "New Mexico",
  "Pennsylvania", "New York", "Oregon", "Rhode Island",
  "Tennessee", "Texas", "Utah", "Vermont"
)

df_repel <- select(popgrowth, x = pop2000, y = popgrowth, state) %>%
  mutate(label = ifelse(state %in% labeled_states, as.character(state), ""))

p_pop <- ggplot(popgrowth, aes(x = pop2000, y = popgrowth, color = region, fill = region)) +
  geom_text_repel(
    data = df_repel,
    aes(x, y, label = label),
    segment.alpha = 0.5, point.padding = 0.25,
    box.padding = .8,
    force = 1,
    min.segment.length = 0.1,
    max.overlaps = 1000,
    size = 10/.pt,
    seed = 7586,
    inherit.aes = FALSE
  ) +
  geom_point(size = 4, color = "white") +
  geom_point(size = 3, shape = 21) +
  scale_x_log10(
    breaks = c(1e6, 3e6, 1e7, 3e7),
    labels = expression(10^6, 3 %*% 10^6, 10^7, 3 %*% 10^7)
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  xlab("population size in 2000") +
  ylab("population growth, 2000 to 2010") +
  theme_minimal_grid(14)

p_pop +  
  scale_fill_manual(values = region_colors) +
  scale_color_manual(values = darken(region_colors, .3))

```

Palette name: Okabe-Ito

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Qualitative scale example

```{r popgrowth-vs-popsize-colored2, out.width = "70%"}

region_colors <- RColorBrewer::brewer.pal(4, "Set1")

p_pop +  
  scale_fill_manual(values = region_colors) +
  scale_color_manual(values = darken(region_colors, .3))

```

Palette name: ColorBrewer Set1

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Qualitative scale example

```{r popgrowth-vs-popsize-colored3, out.width = "70%"}

region_colors <- RColorBrewer::brewer.pal(4, "Set3")

p_pop +  
  scale_fill_manual(values = region_colors) +
  scale_color_manual(values = darken(region_colors, .3))

```

Palette name: ColorBrewer Set3

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Uses of color in data visualization

<table style = "border: none; line-height: 2.5;">
<tr style = "background: white;">
<td style = "text-align: left; width: 50%;">
1. Distinguish categories (qualitative)
</td>
<td>
<img src = "images/qualitative.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>

<tr style = "background: white;">
<td style = "text-align: left;">
2. Represent numeric values (sequential)
</td>
<td>
<img src = "images/sequential.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>
</table>


---

# Sequential scale example

```{r four-locations-temps-by-month, fig.width = 9, fig.asp = .3}
temps_months <- read_csv("data/tempnormals.csv") %>%
  group_by(location, month_name) %>%
  summarize(mean = mean(temperature)) %>%
  mutate(
    month = factor(
      month_name,
      levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
    ),
    location = factor(
      location, levels = c("Death Valley", "Houston", "San Diego", "Chicago")
    )
  ) %>%
  select(-month_name)

p <- ggplot(temps_months, aes(x = month, y = location, fill = mean)) + 
  geom_tile(width = .95, height = 0.95) + 
  scale_y_discrete(name = NULL) +
  coord_fixed(expand = FALSE) +
  theme_half_open() +
  theme(
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 12)
  )

p + scale_fill_viridis_c(
    option = "D",
    name = "temperature (°F)"
  )
```

Palette name: Viridis

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Sequential scale example

```{r four-locations-temps-by-month2, fig.width = 9, fig.asp = .3}
p + scale_fill_viridis_c(
    option = "B", begin = 0.15, end = 0.98,
    name = "temperature (°F)"
  )
```

Palette name: Inferno

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Sequential scale example

```{r four-locations-temps-by-month3, fig.width = 9, fig.asp = .3}
p + scale_fill_viridis_c(
    option = "E",
    name = "temperature (°F)"
  )
```

Palette name: Cividis

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)


---

# Uses of color in data visualization

<table style = "border: none; line-height: 2.5;">
<tr style = "background: white;">
<td style = "text-align: left; width: 50%;">
1. Distinguish categories (qualitative)
</td>
<td>
<img src = "images/qualitative.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>

<tr style = "background: white;">
<td style = "text-align: left;">
2. Represent numeric values (sequential)
</td>
<td>
<img src = "images/sequential.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>

<tr style = "background: white;">
<td style = "text-align: left;">
3. Represent numeric values (diverging)
</td>
<td>
<img src = "images/diverging.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>
</table>

---

# Diverging scale example

```{r forensic-correlations1, fig.asp = 1, fig.width = 4, out.width = "40%"}
forensic_glass <- read_csv("data/forensic_glass.csv")

cm <- cor(select(forensic_glass, -type, -RI, -Si))
df_wide <- as.data.frame(cm)
df_long <- stack(df_wide)
names(df_long) <- c("cor", "var1")
df_long <- cbind(df_long, var2 = rep(rownames(cm), length(rownames(cm))))
clust <- hclust(as.dist(1-cm), method="average") 
levels <- clust$labels[clust$order]
df_long$var1 <- factor(df_long$var1, levels = levels)
df_long$var2 <- factor(df_long$var2, levels = levels)

p <- ggplot(filter(df_long, as.integer(var1) < as.integer(var2)),
       aes(var1, var2, fill=cor)) + 
  geom_tile(color = "white", size = 1) + 
  scale_x_discrete(position = "top", name = NULL, expand = c(0, 0)) +
  scale_y_discrete(name = NULL, expand = c(0, 0)) +
  guides(
    fill = guide_colorbar(
      direction = "horizontal",
      label.position = "bottom",
      title.position = "top",
      barwidth = grid::unit(140, "pt"),
      barheight = grid::unit(17.5, "pt"),
      ticks.linewidth = 1
    )
  ) +
  coord_fixed() +
  theme_half_open(rel_small = 1) +
  theme(
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    axis.ticks.length = grid::unit(3, "pt"),
    legend.position = c(.97, .0),
    legend.justification = c(1, 0),
    legend.title.align = 0.5
  )
p + scale_fill_distiller(
  name = "correlation",
  limits = c(-.5, .5),
  breaks = c(-.5, 0, .5),
  labels = c("–0.5", "0.0", "0.5"),
  type = "div",
  palette = "PiYG",
  direction = 1
)
```

Palette name: ColorBrewer PiYG

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Diverging scale example

```{r forensic-correlations2, fig.asp = 1, fig.width = 4, out.width = "40%"}
p + scale_fill_continuous_divergingx(
  name = "correlation",
  limits = c(-.5, .5),
  breaks = c(-.5, 0, .5),
  labels = c("–0.5", "0.0", "0.5"),
  palette = "Earth",
  rev = FALSE
)
```

Palette name: Carto Earth

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Diverging scale example

```{r forensic-correlations3, fig.asp = 1, fig.width = 4, out.width = "40%"}
p + scale_fill_continuous_diverging(
  name = "correlation",
  limits = c(-.5, .5),
  breaks = c(-.5, 0, .5),
  labels = c("–0.5", "0.0", "0.5"),
  palette = "Blue-Red",
  rev = TRUE
)
```

Palette name: Blue-Red

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Uses of color in data visualization

<table style = "border: none; line-height: 2.5;">
<tr style = "background: white;">
<td style = "text-align: left; width: 50%;">
1. Distinguish categories (qualitative)
</td>
<td>
<img src = "images/qualitative.png" width = 100% style = "text-align: right; vertical-align: middle;"></img>
</td>
</tr>

<tr style = "background: white;">
<td style = "text-align: left;">
2. Represent numeric values (sequential)
</td>
<td>
<img src = "images/sequential.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>

<tr style = "background: white;">
<td style = "text-align: left;">
3. Represent numeric values (diverging)
</td>
<td>
<img src = "images/diverging.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>

<tr style = "background: white;">
<td style = "text-align: left;">
4. Highlight
</td>
<td>
<img src = "images/highlight.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>
</table>

---

# Highlight example

```{r Aus-athletes-track, out.width = "70%"}
male_Aus <- ggridges::Aus_athletes %>%
  filter(sex == "m") %>%
  filter(
    sport %in% c("basketball", "field", "swimming", "track (400m)", "track (sprint)", "water polo")
  ) %>%
  mutate(
    sport = 
      case_when(
        sport == "track (400m)" ~ "track",
        sport == "track (sprint)" ~ "track",
        TRUE ~ sport
      ),
    sport = factor(
      sport,
      levels = c("track", "field", "water polo", "basketball", "swimming")
    )
  )

p <- ggplot(male_Aus, aes(x=height, y=pcBfat, shape=sport, color = sport, fill = sport)) +
  geom_point(size = 3) +
  scale_shape_manual(values = 21:25) +
  xlab("height (cm)") +
  ylab("% body fat") +
  theme_minimal_grid(14)

colors <- c("#BD3828", rep("#808080", 4))
fills <- c(
  alpha(colors[1], .815),
  alpha(colors[2:5], .5)
)

p + 
  scale_color_manual(values = colors) +
  scale_fill_manual(values = fills)
```

Palette name: Grays with accents

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Highlight example

```{r Aus-athletes-track2, out.width = "70%"}

accent_OkabeIto <- c("#E69F00", "#56B4E9", "#CC79A7", "#F0E442", "#0072B2", "#009E73", "#D55E00")
accent_OkabeIto[1:4] <- desaturate(lighten(accent_OkabeIto[1:4], .4), .8)
accent_OkabeIto[5:7] <- darken(accent_OkabeIto[5:7], .3)

colors <- c(accent_OkabeIto[5], darken(accent_OkabeIto[1:4], .2))
fills <- c(
  alpha(accent_OkabeIto[5], .7),
  alpha(accent_OkabeIto[1:4], .7)
)

p + 
  scale_color_manual(values = colors) +
  scale_fill_manual(values = fills)
```

Palette name: Okabe-Ito accent

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Highlight example

```{r Aus-athletes-track3, out.width = "70%"}

accent_Brewer <- RColorBrewer::brewer.pal(7, name = "Accent")[c(7, 1:4)]

colors <- darken(accent_Brewer, .2)
fills <- c(accent_Brewer[1], alpha(accent_Brewer[2:5], .7))

p + 
  scale_color_manual(values = colors) +
  scale_fill_manual(values = fills)
```

Palette name: ColorBrewer accent

???

Figure redrawn from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Uses of color in data visualization

<table style = "border: none; line-height: 2.5;">
<tr style = "background: white;">
<td style = "text-align: left; width: 50%;">
1. Distinguish categories (qualitative)
</td>
<td>
<img src = "images/qualitative.png" width = 100% style = "text-align: right; vertical-align: middle;"></img>
</td>
</tr>

<tr style = "background: white;">
<td style = "text-align: left;">
2. Represent numeric values (sequential)
</td>
<td>
<img src = "images/sequential.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>

<tr style = "background: white;">
<td style = "text-align: left;">
3. Represent numeric values (diverging)
</td>
<td>
<img src = "images/diverging.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>

<tr style = "background: white;">
<td style = "text-align: left;">
4. Highlight
</td>
<td>
<img src = "images/highlight.png" width = 100% style = "text-align: right; vertical-align: middle"></img>
</td>
</tr>
</table>

---

class: inverse, center, middle

# Choosing a color scale

---

# Choosing a color scale

- Emphasis on interpretability and accessibility
- Default palettes are less than desirable
- Variables may require transformations

---

# Default palette in `ggplot2`

```{r}
# generate simulated data points
plots <- purrr::map(1:16, ~ gg_color_swatches(n = .x) +
  ggtitle(paste(.x, "color")))

wrap_plots(plots)
```

---

# Suboptimal default choices

```{r}
# default color palette
p_pop
```

---

# Common forms of color vision deficiency

### Red-green

- Deuteranomaly
- Protanomaly
- Protanopia and deuteranopia

### Blue-yellow

- Tritanomaly
- Tritanopia

### Complete color vision deficiency

- Monochromacy

---

# Inspecting for color vision deficiency

```{r}
# create basic penguins plot
pen_fig <- ggplot(data = penguins, mapping = aes(x = body_mass_g, fill = species)) +
  geom_density(alpha = 0.6) +
  labs(
    x = "Body mass (in grams)",
    fill = "Species"
  ) +
  theme(legend.position = "bottom")
pen_fig
```

---

# Inspecting for color vision deficiency

```{r echo = TRUE, eval = FALSE}
library(colorblindr)
cvd_grid(plot = pen_fig)
```

```{r out.width = "70%"}
{
  pen_fig +
    theme_minimal(base_size = 11)
} %>%
  cvd_grid()
```

---

# Inspecting for color deficiency

```{r}
gg_color_swatches(n = 8) +
  {
    gg_color_swatches(n = 8) %>%
      cvd_grid()
  } +
  plot_layout(widths = c(30, 70)) +
  plot_annotation(title = "Default color palette for 8")
```

---

# Inspecting for color deficiency

```{r}
gg_color_gradient(n = 200) +
  {
    gg_color_gradient(n = 200) %>%
      cvd_grid()
  } +
  plot_layout(widths = c(30, 70)) +
  plot_annotation(title = "Default continuous gradient")
```

---

# When to use quantitative or qualitative color scales?

```{r}
include_graphics(path = "images/quant-qual.png")
```

---

# Use qualitative for nominal variables

```{r}
include_graphics(path = "images/unordered.png")
```

---

# Use qualitative for nominal variables

```{r}
include_graphics(path = "images/unemp-best.png")
```

---

# Quantitative $\neq$ continuous

```{r}
include_graphics(path = "images/likert.png")
```

---

# Shades to emphasize order

```{r}
include_graphics(path = "images/treemap.png")
```

---

# Double-encoded line chart

```{r}
include_graphics(path = "images/double-encode-lines.png")
```

---

# Shades to distinguish subcategories

```{r}
include_graphics(path = "images/subcategories.png")
```

---

# Stick to shades of one hue

```{r}
include_graphics(path = "images/hues-single.png")
```

---

class: inverse, center, middle

# Implementing optimal color palettes in R

---

## **ggplot2** color scale functions are a bit of a mess

--

.small.center[

Scale function            | Aesthetic &nbsp;&nbsp;&nbsp;   | Data type     | Palette type
:-----------              | :----------  | :------------ | :------------
`scale_color_hue()` &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | `color` | discrete  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | qualitative &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
]

---

## **ggplot2** color scale functions are a bit of a mess

.small.center[

Scale function            | Aesthetic &nbsp;&nbsp;&nbsp;   | Data type     | Palette type
:-----------              | :----------  | :------------ | :------------
`scale_color_hue()` &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | `color` | discrete  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | qualitative &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
`scale_fill_hue()`        | `fill `      | discrete      | qualitative
]

---

## **ggplot2** color scale functions are a bit of a mess

.small.center[

Scale function            | Aesthetic &nbsp;&nbsp;&nbsp;   | Data type     | Palette type
:-----------              | :----------  | :------------ | :------------
`scale_color_hue()` &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | `color` | discrete  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | qualitative &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
`scale_fill_hue()`        | `fill `      | discrete      | qualitative
`scale_color_gradient()`  | `color`      | continuous    | sequential
]

---

## **ggplot2** color scale functions are a bit of a mess

.small.center[

Scale function            | Aesthetic &nbsp;&nbsp;&nbsp;   | Data type     | Palette type
:-----------              | :----------  | :------------ | :------------
`scale_color_hue()` &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | `color` | discrete  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | qualitative &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
`scale_fill_hue()`        | `fill `      | discrete      | qualitative
`scale_color_gradient()`  | `color`      | continuous    | sequential
`scale_color_gradient2()` | `color`      | continuous    | diverging
]

---

## **ggplot2** color scale functions are a bit of a mess

.small.center[

Scale function            | Aesthetic &nbsp;&nbsp;&nbsp;   | Data type     | Palette type
:-----------              | :----------  | :------------ | :------------
`scale_color_hue()` &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | `color` | discrete  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | qualitative &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
`scale_fill_hue()`        | `fill `      | discrete      | qualitative
`scale_color_gradient()`  | `color`      | continuous    | sequential
`scale_color_gradient2()` | `color`      | continuous    | diverging
`scale_fill_viridis_c()`   | `color`      | continuous    | sequential
`scale_fill_viridis_d()`   | `fill`       | discrete      | sequential
`scale_color_brewer()`    | `color`      | discrete      | qualitative, diverging, sequential
`scale_fill_brewer()`     | `fill`       | discrete      | qualitative, diverging, sequential
`scale_color_distiller()` | `color`      | continuous    | qualitative, diverging, sequential
]

... and there are many many more

---

## Examples

.panelset[
.panel[.panel-name[Output]
```{r temps-tiles1-out, ref.label = "temps-tiles1", echo = FALSE, fig.asp = .3, dev = "svg"}
```
]

.panel[.panel-name[Code]
```{r temps-tiles1, eval = FALSE, echo = TRUE}
ggplot(temps_months, aes(x = month, y = location, fill = mean)) + 
  geom_tile(width = 0.95, height = 0.95) + 
  coord_fixed(expand = FALSE) +
  theme_classic()
  # no fill scale defined, default is scale_fill_gradient()
```
]
]

---

## Examples

.panelset[
.panel[.panel-name[Output]
```{r temps-tiles2-out, ref.label = "temps-tiles2", echo = FALSE, fig.asp = .3, dev = "svg"}
```
]

.panel[.panel-name[Code]
```{r temps-tiles2, eval = FALSE, echo = TRUE}
ggplot(temps_months, aes(x = month, y = location, fill = mean)) + 
  geom_tile(width = 0.95, height = 0.95) + 
  coord_fixed(expand = FALSE) +
  theme_classic() +
  scale_fill_gradient() #<<
```
]
]

---

## Examples

.panelset[
.panel[.panel-name[Output]
```{r temps-tiles3-out, ref.label = "temps-tiles3", echo = FALSE, fig.asp = .3, dev = "svg"}
```
]

.panel[.panel-name[Code]
```{r temps-tiles3, eval = FALSE, echo = TRUE}
ggplot(temps_months, aes(x = month, y = location, fill = mean)) + 
  geom_tile(width = 0.95, height = 0.95) + 
  coord_fixed(expand = FALSE) +
  theme_classic() +
  scale_fill_viridis_c() #<<
```
]
]

---

## Examples

.panelset[
.panel[.panel-name[Output]
```{r temps-tiles4-out, ref.label = "temps-tiles4", echo = FALSE, fig.asp = .3, dev = "svg"}
```
]

.panel[.panel-name[Code]
```{r temps-tiles4, eval = FALSE, echo = TRUE}
ggplot(temps_months, aes(x = month, y = location, fill = mean)) + 
  geom_tile(width = 0.95, height = 0.95) + 
  coord_fixed(expand = FALSE) +
  theme_classic() +
  scale_fill_viridis_c(option = "B", begin = 0.15) #<<
```
]
]

---

## Examples

.panelset[
.panel[.panel-name[Output]
```{r temps-tiles5-out, ref.label = "temps-tiles5", echo = FALSE, fig.asp = .3, dev = "svg"}
```
]

.panel[.panel-name[Code]
```{r temps-tiles5, eval = FALSE, echo = TRUE}
ggplot(temps_months, aes(x = month, y = location, fill = mean)) + 
  geom_tile(width = 0.95, height = 0.95) + 
  coord_fixed(expand = FALSE) +
  theme_classic() +
  scale_fill_distiller(palette = "YlGnBu") #<<
```
]
]

---

## The `colorspace` package creates some order

Scale name: `scale_<aesthetic>_<datatype>_<colorscale>()`

--

- `<aesthetic>`: name of the aesthetic (`fill`, `color`, `colour`)
- `<datatype>`: type of variable plotted (`discrete`, `continuous`, `binned`)
- `<colorscale>`: type of the color scale (`qualitative`, `sequential`, `diverging`, `divergingx`)

--

Scale function                       | Aesthetic &nbsp;&nbsp;&nbsp; | Data type  | Palette type &nbsp;&nbsp;&nbsp;
:-----------                         | :--------  | :--------- | :------------
`scale_color_discrete_qualitative()` | `color`    | discrete   | qualitative
`scale_fill_continuous_sequential()` | `fill`     | continuous | sequential
`scale_colour_continous_divergingx()` | `colour`   | continuous | diverging

---

## Examples

.panelset[
.panel[.panel-name[Output]
```{r temps-tiles6-out, ref.label = "temps-tiles6", echo = FALSE, fig.asp = .3, dev = "svg"}
```
]

.panel[.panel-name[Code]
```{r temps-tiles6, eval = FALSE, echo = TRUE}
ggplot(temps_months, aes(x = month, y = location, fill = mean)) + 
  geom_tile(width = 0.95, height = 0.95) + 
  coord_fixed(expand = FALSE) +
  theme_classic() +
  scale_fill_continuous_sequential(palette = "YlGnBu", rev = FALSE) #<<
```
]
]

---

## Examples

.panelset[
.panel[.panel-name[Output]
```{r temps-tiles7-out, ref.label = "temps-tiles7", echo = FALSE, fig.asp = .3, dev = "svg"}
```
]

.panel[.panel-name[Code]
```{r temps-tiles7, eval = FALSE, echo = TRUE}
ggplot(temps_months, aes(x = month, y = location, fill = mean)) + 
  geom_tile(width = 0.95, height = 0.95) + 
  coord_fixed(expand = FALSE) +
  theme_classic() +
  scale_fill_continuous_sequential(palette = "Viridis", rev = FALSE) #<<
```
]
]

---

## Examples

.panelset[
.panel[.panel-name[Output]
```{r temps-tiles8-out, ref.label = "temps-tiles8", echo = FALSE, fig.asp = .3, dev = "svg"}
```
]

.panel[.panel-name[Code]
```{r temps-tiles8, eval = FALSE, echo = TRUE}
ggplot(temps_months, aes(x = month, y = location, fill = mean)) + 
  geom_tile(width = 0.95, height = 0.95) + 
  coord_fixed(expand = FALSE) +
  theme_classic() +
  scale_fill_continuous_sequential(palette = "Inferno", begin = 0.15, rev = FALSE) #<<
```
]
]

---

```{r colorspace-palettes-seq, echo = TRUE}
colorspace::hcl_palettes(type = "sequential", plot = TRUE) # all sequential palettes
```

---

```{r colorspace-palettes-div, echo = TRUE}
colorspace::hcl_palettes(type = "diverging", plot = TRUE, n = 9) # all diverging palettes
```

---

```{r colorspace-palettes-divx, echo = TRUE}
colorspace::divergingx_palettes(plot = TRUE, n = 9) # all divergingx palettes
```


---

class: inverse, center, middle

# Setting colors manually for discrete, qualitative scales

---

## Discrete, qualitative scales are best set manually

.panelset[
.panel[.panel-name[Output]
```{r qual-scales-example1-out, ref.label = "qual-scales-example1", echo = FALSE, out.width = "70%"}
```
]

.panel[.panel-name[Code]
```{r qual-scales-example1, eval = FALSE, echo = TRUE}
ggplot(popgrowth, aes(x = pop2000, y = popgrowth, color = region)) +
  geom_point() +
  scale_x_log10()
  # no color scale defined, default is scale_color_hue()
```
]
]

---

## Discrete, qualitative scales are best set manually

.panelset[
.panel[.panel-name[Output]
```{r qual-scales-example2-out, ref.label = "qual-scales-example2", echo = FALSE, out.width = "70%"}
```
]

.panel[.panel-name[Code]
```{r qual-scales-example2, eval = FALSE, echo = TRUE}
ggplot(popgrowth, aes(x = pop2000, y = popgrowth, color = region)) +
  geom_point() +
  scale_x_log10() +
  scale_color_hue() #<<
```
]
]

---

## Discrete, qualitative scales are best set manually

.panelset[
.panel[.panel-name[Output]
```{r qual-scales-example3-out, ref.label = "qual-scales-example3", echo = FALSE, out.width = "70%"}
```
]

.panel[.panel-name[Code]
```{r qual-scales-example3, eval = FALSE, echo = TRUE}
library(ggthemes)  # for scale_color_colorblind()

ggplot(popgrowth, aes(x = pop2000, y = popgrowth, color = region)) +
  geom_point() +
  scale_x_log10() +
  # uses Okabe-Ito colors
  scale_color_colorblind() #<<
```
]
]

---

## Discrete, qualitative scales are best set manually

.panelset[
.panel[.panel-name[Output]
```{r qual-scales-example4-out, ref.label = "qual-scales-example4", echo = FALSE, out.width = "70%"}
```
]

.panel[.panel-name[Code]
```{r qual-scales-example4, eval = FALSE, echo = TRUE}
ggplot(popgrowth, aes(x = pop2000, y = popgrowth, color = region)) +
  geom_point() +
  scale_x_log10() +
  scale_color_manual( #<<
    values = c( #<<
      West = "#E69F00", South = "#56B4E9", #<<
      Midwest = "#009E73", Northeast = "#F0E442" #<<
    ) #<<
  ) #<<
```
]
]

---

## Okabe-Ito RGB codes

.center[
<img src = "https://clauswilke.com/dataviz/pitfalls_of_color_use_files/figure-html/palette-Okabe-Ito-1.png", width = 100%></img>
]

.tiny-font[
Name           | Hex code &nbsp;&nbsp; | R, G, B (0-255)
:----------    | :-------  | :--------
orange         | #E69F00   | 230, 159, 0
sky blue	     | #56B4E9   | 86, 180, 233
bluish green   | #009E73   | 0, 158, 115
yellow	       | #F0E442   | 240, 228, 66
blue	         | #0072B2   | 0, 114, 178
vermilion	     | #D55E00   | 213, 94, 0
reddish purple | #CC79A7   | 204, 121, 167
black	         | #000000   | 0, 0, 0
]

???

Figure from [Claus O. Wilke. Fundamentals of Data Visualization. O'Reilly, 2019.](https://clauswilke.com/dataviz)

---

# Implementing optimal color palettes in R

- [`RColorBrewer`](https://colorbrewer2.org/)
- [`colorspace`](https://colorspace.r-forge.r-project.org/)
- [`viridis`](https://sjmgarnier.github.io/viridis/)

---

# Color Brewer

.panelset[
.panel[.panel-name[Sequential palettes]
```{r}
display.brewer.all(type = "seq")
```
]
.panel[.panel-name[Qualitative palettes]
```{r}
display.brewer.all(type = "qual")
```
]
]

---

# `gss`

```{r echo = TRUE}
data(gss, package = "poliscidata")
gss <- as_tibble(gss)
gss
```

---

# `scale_*_brewer()`

```{r, include = FALSE}
gss_polviews <- drop_na(gss, polviews)
```

.panelset[
.panel[.panel-name[Output]
```{r ref.label = "brewer-seq", echo = FALSE, fig.show = "show", out.width = "70%"}
```
]

.panel[.panel-name[Code]
```{r brewer-seq, echo = TRUE, fig.show = "hide"}
ggplot(data = gss_polviews, mapping = aes(x = polviews, fill = polviews)) +
  geom_bar() +
  scale_fill_brewer(type = "seq") #<<
```
]
]

---

# `scale_*_brewer()`

.panelset[
.panel[.panel-name[Output]
```{r ref.label = "brewer-seq-no-guide", echo = FALSE, fig.show = "show", out.width = "70%"}
```
]

.panel[.panel-name[Code]
```{r brewer-seq-no-guide, echo = TRUE, fig.show = "hide"}
ggplot(data = gss_polviews, mapping = aes(x = polviews, fill = polviews)) +
  geom_bar() +
  scale_fill_brewer(
    type = "seq",
    guide = "none" #<<
  )
```
]
]

---

# Sequential palette

.panelset[
.panel[.panel-name[Output]
```{r ref.label = "brewer-seq-red", echo = FALSE, fig.show = "show", out.width = "70%"}
```
]

.panel[.panel-name[Code]
```{r brewer-seq-red, echo = TRUE, fig.show = "hide"}
ggplot(data = gss_polviews, mapping = aes(x = polviews, fill = polviews)) +
  geom_bar() +
  scale_fill_brewer(
    palette = "OrRd", #<<
    guide = "none"
  )
```
]
]

---

# Qualitative palette

.panelset[
.panel[.panel-name[Output]
```{r ref.label = "brewer-qual-incorrect", echo = FALSE, fig.show = "show", out.width = "70%"}
```
]

.panel[.panel-name[Code]
```{r brewer-qual-incorrect, echo = TRUE, fig.show = "hide"}
gss_relig <- drop_na(gss, relig) %>%
  # collapse low frequency categories to "Other"
  mutate(relig = str_to_title(relig) %>%
    fct_lump_n(n = 7, other_level = "Other") %>%
    fct_infreq())

ggplot(data = gss_relig, mapping = aes(x = relig, fill = relig)) +
  geom_bar() +
  scale_fill_brewer(guide = "none")
```
]
]

---

# Qualitative palette

.panelset[
.panel[.panel-name[Output]
```{r ref.label = "brewer-qual", echo = FALSE, fig.show = "show", out.width = "70%"}
```
]

.panel[.panel-name[Code]
```{r brewer-qual, echo = TRUE, fig.show = "hide"}
ggplot(data = gss_relig, mapping = aes(x = relig, fill = relig)) +
  geom_bar() +
  scale_fill_brewer(
    type = "qual", #<<
    guide = "none"
  )
```
]
]

---

# `viridis`

```{r}
library(viridis)
library(scales)
library(colorspace)
library(dichromat)

n_col <- 128
img <- function(obj, nam) {
  image(1:length(obj), 1, as.matrix(1:length(obj)),
    col = obj,
    main = nam, ylab = "", xaxt = "n", yaxt = "n", bty = "n"
  )
}

par(mfrow = c(8, 1), mar = rep(1, 4))
img(rev(viridis(n_col)), "viridis")
img(rev(magma(n_col)), "magma")
img(rev(plasma(n_col)), "plasma")
img(rev(inferno(n_col)), "inferno")
img(rev(cividis(n_col)), "cividis")
img(rev(mako(n_col)), "mako")
img(rev(rocket(n_col)), "rocket")
img(rev(turbo(n_col)), "turbo")
```

---

# Comparison of palettes

```{r}
par(mfrow = c(7, 1), mar = rep(1, 4))
img(rev(rainbow(n_col)), "rainbow")
img(rev(heat.colors(n_col)), "heat")
img(rev(seq_gradient_pal(low = "#132B43", high = "#56B1F7", space = "Lab")(seq(0, 1, length = n_col))), "ggplot default")
img(gradient_n_pal(brewer_pal(type = "seq")(9))(seq(0, 1, length = n_col)), "brewer blues")
img(gradient_n_pal(brewer_pal(type = "seq", palette = "YlGnBu")(9))(seq(0, 1, length = n_col)), "brewer yellow-green-blue")
img(rev(viridis(n_col)), "viridis")
img(rev(magma(n_col)), "magma")
```

---

# Green-Blind (Deuteranopia)

```{r}
par(mfrow = c(7, 1), mar = rep(1, 4))
img(dichromat(rev(rainbow(n_col)), "protan"), "rainbow")
img(dichromat(rev(heat.colors(n_col)), "protan"), "heat")
img(dichromat(rev(seq_gradient_pal(low = "#132B43", high = "#56B1F7", space = "Lab")(seq(0, 1, length = n_col))), "protan"), "ggplot default")
img(dichromat(gradient_n_pal(brewer_pal(type = "seq")(9))(seq(0, 1, length = n_col)), "protan"), "brewer blues")
img(dichromat(gradient_n_pal(brewer_pal(type = "seq", palette = "YlGnBu")(9))(seq(0, 1, length = n_col)), "protan"), "brewer yellow-green-blue")
img(dichromat(rev(viridis(n_col)), "protan"), "viridis")
img(dichromat(rev(magma(n_col)), "protan"), "magma")
```

---

# Desaturated

```{r}
par(mfrow = c(7, 1), mar = rep(1, 4))
img(desaturate(rev(rainbow(n_col))), "rainbow")
img(desaturate(rev(heat.colors(n_col))), "heat")
img(desaturate(rev(seq_gradient_pal(low = "#132B43", high = "#56B1F7", space = "Lab")(seq(0, 1, length = n_col)))), "ggplot default")
img(desaturate(gradient_n_pal(brewer_pal(type = "seq")(9))(seq(0, 1, length = n_col))), "brewer blues")
img(desaturate(gradient_n_pal(brewer_pal(type = "seq", palette = "YlGnBu")(9))(seq(0, 1, length = n_col))), "brewer yellow-green-blue")
img(desaturate(rev(viridis(n_col))), "viridis")
img(desaturate(rev(magma(n_col))), "magma")
```

---

# `viridis` - continuous


---

# `viridis` - continuous

---

# `viridis` - discrete

```{r echo = TRUE, fig.height = 6}
ggplot(data = gss_polviews, mapping = aes(x = polviews, fill = polviews)) +
  geom_bar() +
  scale_fill_viridis_d(guide = "none")
```

---

class: middle, center, inverse

# Exercise on implementing palettes

```{r cache = FALSE}
countdown(minutes = 8)
```

---

# When to use sequential or diverging color scales?

```{r}
include_graphics(path = "images/seq-div.png")
```

---

# Except when you shouldn't!

- Meaningful middle point
- Emphasize extremes
- See more differences

---

# Meaningful middle point

```{r}
include_graphics(path = "images/div-palette.png")
```

- Zero
- 50%
- Average
- Agreed threshold
- A target

---

# WTF?

```{r}
include_graphics(path = "images/pepmusic.png")
```

---

# Emphasize highest values

```{r}
# get internet usage data file
internet_use <- read_csv(file = "data/internet-consumption.csv") %>%
  rename(usage = `internet usage`) %>%
  mutate(usage = usage / 100)

# get global shapefile
world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  filter(continent != "Antarctica")

# join together
internet_sf <- left_join(x = world, y = internet_use, by = c("iso_a3" = "code"))
```

```{r}
internet_plot <- ggplot(data = internet_sf, mapping = aes(fill = usage)) +
  geom_sf(color = "white") +
  coord_sf(crs = "+proj=robin") +
  labs(
    title = "Share of individuals using the internet in the last 3 months",
    subtitle = "2015",
    fill = NULL
  ) +
  theme_map(base_size = rcfss::base_size - 4)

internet_plot +
  scale_fill_distiller(type = "seq", labels = scales::percent, direction = +1)
```

---

# Emphasize extremes

```{r}
internet_plot +
  scale_fill_distiller(type = "div", labels = scales::percent)
```

---

# Increased range in scale

```{r}
include_graphics(path = "images/births-div.png")
```

---

# Increased range in scale

```{r}
include_graphics(path = "images/births-seq.png")
```

---

# Implementing diverging palettes

```{r echo = TRUE, fig.height = 6}
ggplot(data = gss_polviews, mapping = aes(x = polviews, fill = polviews)) +
  geom_bar() +
  scale_fill_brewer(type = "div", guide = "none")
```

---

# Implementing diverging palettes


---

# Implementing diverging palettes


---

class: center, middle, inverse

# Exercise on diverging palettes

```{r cache = FALSE}
countdown(minutes = 8)
```

---

# When to use classed or unclassed color scales?

```{r}
include_graphics(path = "images/class-scale.png")
```

---

# Use a classed scale if the data is classed

```{r}
include_graphics(path = "images/class-continuous.png")
```

---

# Communicating statistical brackets

```{r}
# unemployment above or below the national average for March 2021 - 6%
unemp_oct21 <- read_csv(file = "data/unemp-oct-20.csv") %>%
  rename(
    unemp = `unemployment rate`,
    county_fips = fips
  ) %>%
  mutate(
    us_avg = unemp >= 6.9,
    unemp = unemp / 100,
    # cap max unemp rate for demo purposes only
    unemp_cap = if_else(unemp > 0.15, 0.15, unemp)
  )

county_sf <- get_urbn_map(map = "counties", sf = TRUE)

unemp_oct21 <- inner_join(county_sf, unemp_oct21)

# get US shapefile
states_sf <- get_urbn_map("states", sf = TRUE)
```

```{r}
unemp_class <- ggplot(data = unemp_oct21) +
  geom_sf(mapping = aes(fill = us_avg), color = "white", size = .1) +
  geom_sf(data = states_sf, color = "white", fill = NA, size = .3) +
  scale_fill_manual(values = c("grey", "maroon"), labels = c("< 6.9%", ">= 6.9%")) +
  labs(title = "Counties with an unemployment rate above the\nnational average and below in October 2020", fill = NULL) +
  theme_map(base_size = rcfss::base_size - 4) +
  theme(legend.position = "bottom")
unemp_class
```

---

# Communicating general patterns

```{r}
unemp_unclass <- ggplot(data = unemp_oct21) +
  geom_sf(mapping = aes(fill = unemp_cap), color = "white", size = .1) +
  geom_sf(data = states_sf, color = "white", fill = NA, size = .3) +
  scale_fill_distiller(
    palette = "PuOr",
    values = scales::rescale(c(0.004, 0.06, 0.15)),
    breaks = c(0.004, 0.06, 0.15),
    labels = c("Lower", "National average", "Higher")
  ) +
  labs(title = "Unemployment rate", subtitle = "October 2020", fill = NULL) +
  theme_map(base_size = rcfss::base_size - 4)
unemp_unclass
```

---

# Increased classes for more nuance

```{r}
unemp_class6 <- unemp_oct21 %>%
  mutate(unemp_cap = cut_number(unemp_cap, n = 6)) %>%
  ggplot() +
  geom_sf(mapping = aes(fill = unemp_cap), color = "white", size = .1) +
  geom_sf(data = states_sf, color = "white", fill = NA, size = .3) +
  scale_fill_brewer(palette = "PuOr", direction = -1) +
  labs(title = "Unemployment rate", subtitle = "October 2020", fill = NULL) +
  theme_map(base_size = rcfss::base_size - 4)
unemp_class6
```

---

# Assisting with interpretations

```{r}
{
  unemp_unclass +
    theme(legend.position = "none") +
    coord_sf(xlim = c(-109, -91), ylim = c(39, 49), crs = 4326)
} + {
  unemp_class6 +
    theme(legend.position = "none") +
    coord_sf(xlim = c(-109, -91), ylim = c(39, 49), crs = 4326)
}
```

---

# Directly encoding values

```{r}
{
  unemp_unclass +
    labs(title = NULL, subtitle = NULL) +
    coord_sf(xlim = c(-109, -91), ylim = c(39, 49), crs = 4326) +
    scale_fill_distiller(
      palette = "PuOr",
      values = scales::rescale(c(0.004, 0.06, 0.15)),
      breaks = c(0.01, 0.03, 0.05, 0.069, 0.09, 0.11, 0.14),
      labels = scales::percent
    )
} + {
  unemp_oct21 %>%
    mutate(unemp_cap = cut_interval(unemp_cap, n = 6) %>%
      factor(labels = c("1-3%", "3-5%", "5-7.9%", "8-10%", "10-12.9%", "13-15%"))) %>%
    ggplot() +
    geom_sf(mapping = aes(fill = unemp_cap), color = "white", size = .1) +
    geom_sf(data = states_sf, color = "white", fill = NA, size = .3) +
    scale_fill_brewer(palette = "PuOr", direction = -1) +
    labs(fill = NULL) +
    coord_sf(xlim = c(-109, -91), ylim = c(39, 49), crs = 4326) +
    theme_map(base_size = rcfss::base_size - 4)
}
```

---

# Choosing an interpolation

- Linear
- Quartiles, quantiles, deciles

---

# Linear

```{r}
ggplot(data = unemp_oct21, mapping = aes(x = unemp, fill = ..x..)) +
  geom_histogram() +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_viridis_c(direction = -1, labels = percent_format(accuracy = 1)) +
  labs(
    title = "Unemployment rate",
    subtitle = "By county",
    x = "Unemployment rate",
    y = NULL,
    fill = NULL
  ) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(3, "cm")
  )
```

---

# Linear

```{r}
ggplot(data = unemp_oct21, mapping = aes(fill = unemp)) +
  geom_sf(mapping = aes(fill = unemp), color = "white", size = .1) +
  geom_sf(data = states_sf, color = "white", fill = NA, size = .3) +
  scale_fill_viridis_c(direction = -1, labels = percent_format(accuracy = 1)) +
  labs(title = "Unemployment rate", subtitle = "October 2020", fill = NULL) +
  theme_map(base_size = rcfss::base_size - 4) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(2, "cm")
  )
```

---

# Quartiles

```{r}
ggplot(data = unemp_oct21, mapping = aes(fill = unemp)) +
  geom_sf(mapping = aes(fill = unemp), color = "white", size = .1) +
  geom_sf(data = states_sf, color = "white", fill = NA, size = .3) +
  scale_fill_viridis_b(direction = -1, labels = percent_format(accuracy = 1), n.breaks = 3, nice.breaks = FALSE) +
  labs(title = "Unemployment rate", subtitle = "October 2020", fill = NULL) +
  theme_map(base_size = rcfss::base_size - 4) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(2, "cm")
  )
```

---

# Quintiles

```{r}
ggplot(data = unemp_oct21, mapping = aes(fill = unemp)) +
  geom_sf(mapping = aes(fill = unemp), color = "white", size = .1) +
  geom_sf(data = states_sf, color = "white", fill = NA, size = .3) +
  scale_fill_viridis_b(direction = -1, labels = percent_format(accuracy = 1), n.breaks = 4, nice.breaks = FALSE) +
  labs(title = "Unemployment rate", subtitle = "October 2020", fill = NULL) +
  theme_map(base_size = rcfss::base_size - 4) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(2, "cm")
  )
```

---

# Deciles

```{r}
ggplot(data = unemp_oct21, mapping = aes(fill = unemp)) +
  geom_sf(mapping = aes(fill = unemp), color = "white", size = .1) +
  geom_sf(data = states_sf, color = "white", fill = NA, size = .3) +
  scale_fill_viridis_b(direction = -1, labels = percent_format(accuracy = 1), n.breaks = 9, nice.breaks = FALSE) +
  labs(title = "Unemployment rate", subtitle = "October 2020", fill = NULL) +
  theme_map(base_size = rcfss::base_size - 4) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(3, "cm")
  )
```

---

# Natural breaks

```{r}
library(classInt)

unemp_classes <- classIntervals(unemp_oct21$unemp, n = 5, style = "jenks")

unemp_oct21 %>%
  mutate(unemp_cat = kimisc::cut_format(unemp, unemp_classes$brks,
    include.lowest = TRUE,
    format_fun = percent
  )) %>%
  ggplot(mapping = aes(fill = unemp_cat)) +
  geom_sf(mapping = aes(fill = unemp_cat), color = "white", size = .1) +
  geom_sf(data = states_sf, color = "white", fill = NA, size = .3) +
  scale_fill_viridis_d(direction = -1) +
  labs(title = "Unemployment rate", subtitle = "October 2020", fill = NULL) +
  theme_map(base_size = rcfss::base_size - 4)
```

---

# Implementing breaks

- Automatically with `scale_*_viridis_b()`
- Manually with `cut_number()`

---

# Quartiles

.pull-left[

```{r quart, echo = TRUE, eval = FALSE}
ggplot(
  data = unemp_oct21,
  mapping = aes(fill = unemp)
) +
  geom_sf(color = "white", size = .1) +
  scale_fill_viridis_b(
    n.breaks = 3,
    nice.breaks = FALSE
  )
```

]

.pull-right[

```{r quart-out, ref.label = "quart", eval = TRUE, echo = FALSE, fig.width = 6}

```

]

---

# Quintiles

.pull-left[

```{r quint, echo = TRUE, eval = FALSE}
ggplot(
  data = unemp_oct21,
  mapping = aes(fill = unemp)
) +
  geom_sf(color = "white", size = .1) +
  scale_fill_viridis_b(
    n.breaks = 4,
    nice.breaks = FALSE
  )
```

]

.pull-right[

```{r quint-out, ref.label = "quint", eval = TRUE, echo = FALSE, fig.width = 6}

```

]

---

# Deciles

.pull-left[

```{r dec, echo = TRUE, eval = FALSE}
ggplot(
  data = unemp_oct21,
  mapping = aes(fill = unemp)
) +
  geom_sf(color = "white", size = .1) +
  scale_fill_viridis_b(
    n.breaks = 9,
    nice.breaks = FALSE
  )
```

]

.pull-right[

```{r dec-out, ref.label = "dec", eval = TRUE, echo = FALSE, fig.width = 6}

```

]

---

# Manually with `cut_number()`

.pull-left[

```{r quart-man, echo = TRUE, eval = FALSE}
unemp_oct21 %>%
  mutate(unemp = cut_number(unemp, n = 4)) %>%
  ggplot(mapping = aes(fill = unemp)) +
  geom_sf(color = "white", size = .1) +
  scale_fill_brewer(type = "seq")
```

]

.pull-right[

```{r quart-man-out, ref.label = "quart-man", eval = TRUE, echo = FALSE, fig.width = 6}

```

]

---

# Manually with `cut_number()`

.pull-left[

```{r quint-man, echo = TRUE, eval = FALSE}
unemp_oct21 %>%
  mutate(unemp = cut_number(unemp, n = 5)) %>%
  ggplot(mapping = aes(fill = unemp)) +
  geom_sf(color = "white", size = .1) +
  scale_fill_brewer(type = "seq")
```

]

.pull-right[

```{r quint-man-out, ref.label = "quint-man", eval = TRUE, echo = FALSE, fig.width = 6}

```

]

---

# Manually with `cut_number()`

.pull-left[

```{r dec-man, echo = TRUE, eval = FALSE}
unemp_oct21 %>%
  mutate(unemp = cut_number(unemp, n = 10)) %>%
  ggplot(mapping = aes(fill = unemp)) +
  geom_sf(color = "white", size = .1) +
  scale_fill_brewer(type = "seq")
```

]

.pull-right[

```{r dec-man-out, ref.label = "dec-man", eval = TRUE, echo = FALSE, fig.width = 6}

```

]

---

# Natural breaks

.pull-left[

```{r nat-break, echo = TRUE, eval = FALSE}
library(classInt)

# calculate intervals
unemp_classes <- classIntervals(unemp_oct21$unemp,
  n = 5,
  style = "jenks"
)

unemp_oct21 %>%
  # apply to variable
  mutate(unemp_cat = kimisc::cut_format(
    x = unemp,
    breaks = unemp_classes$brks,
    include.lowest = TRUE,
    format_fun = scales::percent
  )) %>%
  ggplot(mapping = aes(fill = unemp_cat)) +
  geom_sf(color = "white", size = .1)
```

]

.pull-right[

```{r nat-break-out, ref.label = "nat-break", eval = TRUE, echo = FALSE, fig.width = 6}

```

]

---

class: middle, center, inverse

# Exercises on interpolating continuous variables

```{r cache = FALSE}
countdown(minutes = 7)
```
